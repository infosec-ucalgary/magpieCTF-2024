#include <stdlib.h>
#include <stdio.h>
#include <unistd.h>
#include <stdbool.h>
typedef unsigned long *ulongptr;
void get_secret(){
	system("cat flag.txt");
	exit(0);
}
struct PRODUCT{
	int product_id;
	int product_price;
	char *product_name;
	void (*product_manual)();
	void (*product_review)();
};
void product_review(){
	printf("There are not any reviews yet. Be the first one!\n");
}
void product_manual(){
	printf("Product manual coming soon!\n");
}

struct ACCOUNT{
	int account_id;
	int credit;
	char username[8];
	bool subscribed[8];
	void (*view_your_credentials)();
};
struct ACCOUNT *accounts[8];
struct PRODUCT *products[7];
int account_ids=0, product_ids=0;

void create_account(){
	if(account_ids<sizeof(accounts)){
		struct ACCOUNT *tmp=malloc(sizeof(struct ACCOUNT));
		tmp->account_id=account_ids;
		printf("ID: %d\n", tmp->account_id);
		printf("Store this ID somewhere as it will only appear once!\n");
		
		tmp->credit=0;
		printf("Credit left: %d\n",tmp->credit);

		printf("Enter a username: \n");
		fgets(tmp->username,8, stdin);
		tmp->view_your_credentials=get_secret;
		
		accounts[account_ids++]=tmp;
	}else{
		printf("Running out of memory! Exiting...\n");
		exit(-1);
	}
}

void remove_account(int id){
	printf("Removing account %d", id);
	free(accounts[id]);
	memset(accounts[id], 0, sizeof(struct ACCOUNT));
}
void add_product(int choice){
	struct PRODUCT *new_product=malloc(sizeof(struct PRODUCT));
	new_product->product_id=product_ids++;
	switch(choice){
		case 1:
			new_product->product_price=709;
			new_product->product_name="RFID1337";
			break;
		case 2:
			new_product->product_price=30;
			new_product->product_name="SLit2005";
			break;
		case 3:
			new_product->product_price=120;
			new_product->product_name="DgFinger";
			break;
		case 4:
			new_product->product_price=2200;
			new_product->product_name="FaceReco";
			break;
		case 5:
			new_product->product_price=2334;
			new_product->product_name="SRetinal";
			break;
		case 6:
			new_product->product_price=450;
			new_product->product_name="MotionX6";
			break;
		default:
			new_product->product_price=140;
			new_product->product_name="DigtLock";
			break;
	}
	new_product->product_manual=product_manual;
	new_product->product_review=product_review;
	products[choice-1]=new_product;
}
void product_init(){
	for(int i=1;i<8;i++){
		add_product(i);
	}
}
void product_detail(int choice){
	struct PRODUCT *pt=products[choice-1];
	printf("Name: %s\n", pt->product_name);
	printf("Price: %d\n", pt->product_price);
	pt->product_manual();
	pt->product_review();
}
void remove_product(int choice){
	free(products[choice-1]);
	printf("Product %d removed.\n", choice);
	memset(products[choice-1],0,sizeof(struct PRODUCT));
}
int product_choice(){

	char choice_c;
	scanf("%c",choice_c);
	if(choice_c<48||choice_c>55){
		printf("Invalid character.");
		exit(-2);
	}
	int choice_i=atoi(choice_c);
	if(!products[0]){
		product_init();
	}
	return choice_i;

}
int main(){
	setbuf(stdout, NULL);
	
	char *main_menu="Welcome to BinCortex solution!\n"
		"We develop most of the software and APIs for many of the modern androids you might see for sale or on the street.\n"
		"Please choose an option to begin:\n"
		"0. Exit\n"
		"1. List products\n"
		"2. See product details\n"
		"3. Create an account\n"
		"4. Purchase a product\n"
	        "5. View your credential\n";	
		"6. Remove an account\n";
		"7. Report an error\n";

	char *product_menu="We have the following products:\n"
		"1. RFID1337(door entry RFID device)\n"
		"2. SLit2005 (smart light for home)\n"
		"3. DgFinger (fingerprint scanner)\n"
		"4. FaceReco (face recognition monitoring system)\n"
		"5. SRetinal (retinal scanner for identity verification)\n"
		"6. MotionX6 (motion invoking camera)\n"
		"7. DigtLock (pure numerical digital lock)\n";
	char choice;
	scanf("%c", choice);
	switch(choice){
		case '1':
			printf("%s\n", product_menu);
			break;
		case '2':
			printf("Which product would you like to see?");
			int choice_i=product_choice();
			product_detail(choice_i);
			break;
		case '3':
			create_account();
			break;
		case '4':
			printf("Please enter your account ID: \n");
			char id_c;
			scanf("%c", id_c);
			if(id_c<48||id_c>56){
				printf("Invalid character.");
				exit(-2);
			}
			int id_i=atoi(id_c);
			printf("Which product would you like to purchase?");
			printf("%s\n", product_menu);
			int choice_i=product_choice();
			printf("How many would you like to buy?");

			accounts[id_i]->credit



			
	}
	/*add_product(1);
	remove_product(1);
	create_account();
	products[0]->product_review();*/
}
