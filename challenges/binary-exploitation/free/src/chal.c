#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <unistd.h>
#include <stdbool.h>
#include <limits.h>

#define FLAG_SIZE 35

typedef unsigned long *ulongptr;
int account_ids=0, product_ids=0;

struct PRODUCT{
	int product_id;
	int product_price;
	char *product_name;
	void (*product_manual)();
	void (*product_review)();
};

struct ACCOUNT{
	int account_id;
	int credit;
	char username[8];
	bool subscribed[8];
	void (*view_your_credentials)();
};

struct ACCOUNT *accounts[8];
struct PRODUCT *products[7];

bool *accounts_available[8]={false};
bool *products_available[7]={false};

int get_safe_uint_range(int min, int max){
	char c=getc(stdin);
	char buf[11];
	
	for(int count=0;count<10 && c!='\n';count++){
		if(c<48||c>57){
			printf("invalid character");
			exit(-3);
		}
		buf[count]=c;
		c=getc(stdin);
	}
	int res=atoi(buf);
	if(res<min||res>max){
		printf("value out of range");
		exit(-3);
	}
	return res;
}

int get_safe_uint(){
	return get_safe_uint_range(0, INT_MAX);
}

void get_secret(){
	FILE *f;
	f=fopen("flag.txt", "r");
	char flag[FLAG_SIZE];
	if(fgets(flag, FLAG_SIZE, f)) {
	  printf("%s\n", flag);
	}
	fclose(f);
	exit(0);
}

void product_manual(){
	printf("Not available at the moment\n");
}
void product_review(){
	printf("No reviews yet\n");
}

void see_manual(int choice){
	struct PRODUCT *pt=products[choice];
	pt->product_manual();
	printf("\n");
}
void see_review(int choice){
	struct PRODUCT *pt=products[choice];
	pt->product_review();
	printf("\n");
}
void add_product(int choice){
	products_available[choice]=true;
	struct PRODUCT *new_product=malloc(sizeof(struct PRODUCT));
	new_product->product_id=product_ids++;
	switch(choice){
		case 0:
			new_product->product_price=641;
			new_product->product_name="RFID1337";
			break;
		case 1:
			new_product->product_price=29;
			new_product->product_name="SLit2005";
			break;
		case 2:
			new_product->product_price=89;
			new_product->product_name="DgFinger";
			break;
		case 3:
			new_product->product_price=2200;
			new_product->product_name="FaceReco";
			break;
		case 4:
			new_product->product_price=2334;
			new_product->product_name="SRetinal";
			break;
		case 5:
			new_product->product_price=257;
			new_product->product_name="MotionX6";
			break;
		default:
			new_product->product_price=563;
			new_product->product_name="DigtLock";
			break;
	}
	new_product->product_manual=product_manual;
	new_product->product_review=product_review;
	products[choice]=new_product;
}
void product_init(){
	for(int i=0;i<7;i++){
		add_product(i);
	}
}
void list_price(){
	for(int i=0;i<7;i++){
		struct PRODUCT *pt=products[i];
		printf("%d. %s:\t", i+1, pt->product_name);
		printf("$%d\n", pt->product_price);
		
	}
}
void remove_product(int choice){
	products_available[choice]=false;
	struct PRODUCT *p=products[choice];
	memset(p,0,sizeof(struct PRODUCT));
	free(p);
}
void print_products(){
	printf("We have the following products:\n");
	char *product_menu[]={
		"1. RFID1337 (door entry RFID device)",
		"2. SLit2005 (smart light for home)",
		"3. DgFinger (fingerprint scanner)",
		"4. FaceReco (face recognition monitoring system)",
		"5. SRetinal (retinal scanner for identity verification)",
		"6. MotionX6 (motion invoking camera)",
		"7. DigtLock (pure numerical digital lock)"};
	for(int i=0;i<7;i++){
		if(products_available[i]){
			printf("%s\n", product_menu[i]);
		}else{
			printf("%s unavailable\n", product_menu[i]);
		}
	}
	printf("\n");
}

int product_choice(){

	int choice=get_safe_uint_range(1,7);
	if(!products_available[choice]){
		printf("Product not available");
		exit(-1);
	}
	return choice-1;

}

void create_account(){	
	if(account_ids<sizeof(accounts)){
		accounts_available[account_ids]=true;
		struct ACCOUNT *tmp=malloc(sizeof(struct ACCOUNT));
		tmp->account_id=account_ids;
		printf("Account created!\n");
		printf("ID: %d\n", tmp->account_id);
		tmp->credit=0;

		tmp->view_your_credentials=get_secret;
		
		accounts[account_ids++]=tmp;
	}else{
		printf("Running out of memory! Exiting...\n");
		exit(-1);
	}
	printf("\n");
}

void remove_account(int id){
	accounts_available[id]=false;
	printf("Removing account %d", id);
	memset(accounts[id],0,sizeof(struct ACCOUNT));
	free(accounts[id]);
}
int get_id(){

	printf("Please enter your account ID: ");
	int id=get_safe_uint_range(0,7);
	if(!accounts_available[id]){
		printf("account not exist");
		exit(-1);
	}
	return id;
}
int main(){
	
	setbuf(stdout, NULL);

	bool developer_mode=false;

	product_init();
	char *main_menu="Welcome to BinCortex solution!\n"
		"We develop most of the software and APIs for many of the modern devices you might see for sale or on the street.\n"
		"Please choose an option to begin:\n"
		"0. Exit\n"
		"1. List products\n"
		"2. See product details\n"
		"3. Create an account\n"
		"4. Purchase a product\n"
		"5. Remove an account\n"
		"6. See review\n"
		"7. View account balance\n";

	char *hidden_menu="Welcome to BinCortex solution!\n"
		"You have unlocked the developer mode\n"
		"Please select an option:\n"
		"0. Exit\n"
		"1. List products\n"
		"2. See product details\n"
		"3. Create an account\n"
		"4. Purchase a product\n"
		"5. Remove an account\n"
		"6. See review\n"
		"7. View account balance\n"
		"8. Remove a product\n";



	int choice,choice_i, id_i;
	do{
		if(developer_mode){
			printf("%s\n", hidden_menu);
		}else{
			printf("%s\n", main_menu);
		}
		printf("\nYour choice: ");
		if(developer_mode){
			choice=get_safe_uint_range(0,8);
		}else{
			choice=get_safe_uint_range(0,7);
		}
		switch(choice){
			case 0:
				printf("Existing...\n");
				break;
			case 1:
				print_products();
				printf("\n");
				break;
			case 2:
				print_products();
				printf("Which product would you like to see? ");
				choice_i=product_choice();
				printf("Price: %d\n", products[choice_i]->product_price);
				printf("Manual: ");
				see_manual(choice_i);

				printf("\n");
				break;
			case 3:
				create_account();
				printf("\n");
				break;
			case 4:
				id_i=get_id();
				list_price();
				printf("Which product would you like to purchase? ");
				choice_i=product_choice();
				printf("How many would you like to buy? ");
				//safely getting integer input here
				//int amount=6700417;
				int amount=get_safe_uint();
				//This is used for testing
				//accounts[id_i]->credit=-1;
				accounts[id_i]->credit-=((products[choice_i]->product_price)*amount);
				if(accounts[id_i]->credit>0){
					printf("Transaction submitted\n");
					printf("You have %d credits left\n",accounts[id_i]->credit);
				}else if(accounts[id_i]->credit==-1){
					printf("Unlocking developer feature...\n");
					developer_mode=true;
				}else{
					printf("Not enough free credits\n");	
					exit(-4);
				}
				printf("\n");
				break;
			case 5:
				id_i=get_id();
				printf("Removing account...\n");
				remove_account(id_i);
				printf("Account successfully removed!\n");
				printf("\n");
				break;
			case 6:
				printf("Which product you you like to see the review for? ");
				print_products();
				see_review(product_choice());
				printf("\n");
				break;
			case 7:
				id_i=get_id();
				printf("Remaining credit: %d\n",accounts[id_i]->credit);
				break;

			case 8:
				printf("Which product would you like to remove? ");
				print_products();
				remove_product(product_choice());
				printf("Product removed...\n");
				printf("\n");
				break;
		}
		sleep(1);
	}while(choice!=0);
	
}
